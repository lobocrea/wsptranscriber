# Caddyfile optimizado para WSP Transcriber
# Configuración para proxy reverso con SSL automático

wsptranscriber.lobocrea.pro {
    # Proxy reverso al contenedor de la aplicación
    reverse_proxy wsptranscriber-app:3000 {
        # Headers para Next.js
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # Health check para el upstream
        health_uri /
        health_interval 30s
        health_timeout 10s
        health_status 2xx
    }
    
    # Configuración de logs
    log {
        output file /var/log/caddy/wsptranscriber.log {
            roll_size 10MB
            roll_keep 5
        }
        format json
        level INFO
    }
    
    # Headers de seguridad
    header {
        # Seguridad básica
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
        
        # HSTS (solo en producción)
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # CSP básico (ajustar según necesidades)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:;"
    }
    
    # Compresión
    encode gzip zstd
    
    # Manejo de archivos estáticos con cache
    @static {
        path /_next/static/* /favicon.ico /robots.txt /sitemap.xml
    }
    header @static Cache-Control "public, max-age=31536000, immutable"
    
    # Manejo de uploads grandes (para archivos de WhatsApp)
    request_body {
        max_size 100MB
    }
}

# Redirección de www (opcional)
www.wsptranscriber.lobocrea.pro {
    redir https://wsptranscriber.lobocrea.pro{uri} permanent
}

# Configuración global
{
    # Email para Let's Encrypt
    email admin@lobocrea.pro
    
    # Configuración de ACME
    acme_ca https://acme-v02.api.letsencrypt.org/directory
    
    # Configuración de logs globales
    log {
        level INFO
    }
    
    # Configuración de admin API (opcional, para métricas)
    admin localhost:2019
}
